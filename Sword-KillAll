local aB3dE,bT2xK,cL9pR=game:service'Players',game:service'RunService',game:service'CoreGui'
local dE4fG=game:service'UserInputService'
local dV6nH=aB3dE.LocalPlayer
local eJ3sW,fY8kP,gR1cU,hN2mQ={}, {}, nil, false
local iP4sT,jK7uL,kM8qT,lQ3wE=nil,nil,nil,nil

local mF9xC=Instance.new('ScreenGui')
mF9xC.ResetOnSpawn=false
mF9xC.Parent=cL9pR
local nR5vB=Instance.new('Frame')
nR5vB.Size=UDim2.new(0,150,0,46)
nR5vB.Position=UDim2.new(0,12,1,-58)
nR5vB.BackgroundTransparency=.35
nR5vB.BorderSizePixel=0
nR5vB.BackgroundColor3=Color3.fromRGB(0,0,0)
nR5vB.Parent=mF9xC
Instance.new('UICorner',nR5vB).CornerRadius=UDim.new(0,14)
local oT1zK=Instance.new('UIStroke')
oT1zK.Thickness=2
oT1zK.Transparency=.25
oT1zK.Color=Color3.fromRGB(255,255,255)
oT1zK.Parent=nR5vB
local pD9hV=Instance.new('TextButton')
pD9hV.Size=UDim2.new(1,-10,1,-10)
pD9hV.Position=UDim2.new(0,5,0,5)
pD9hV.BackgroundTransparency=0
pD9hV.BorderSizePixel=0
pD9hV.BackgroundColor3=Color3.fromRGB(0,0,0)
pD9hV.AutoButtonColor=false
pD9hV.Font=Enum.Font.Code
pD9hV.TextSize=20
pD9hV.Text='OFF'
pD9hV.TextTransparency=.05
pD9hV.TextColor3=Color3.fromRGB(255,255,255)
pD9hV.Parent=nR5vB
Instance.new('UICorner',pD9hV).CornerRadius=UDim.new(0,12)
local qW8cS=Instance.new('UIStroke')
qW8cS.Thickness=1
qW8cS.Transparency=.35
qW8cS.Color=Color3.fromRGB(255,255,255)
qW8cS.Parent=pD9hV

local rQ1wE={'Team','Height','Both','None','Select'}
local sV2xK=4
local xY7zA,yM2nP,zR3tU=nil,{},{}
local tB3nM=Instance.new('Frame')
tB3nM.Size=UDim2.new(0,150,0,46)
tB3nM.Position=UDim2.new(0,12,1,-108)
tB3nM.BackgroundTransparency=.35
tB3nM.BorderSizePixel=0
tB3nM.BackgroundColor3=Color3.fromRGB(0,0,0)
tB3nM.Parent=mF9xC
Instance.new('UICorner',tB3nM).CornerRadius=UDim.new(0,14)
local uC4vP=Instance.new('UIStroke')
uC4vP.Thickness=2
uC4vP.Transparency=.25
uC4vP.Color=Color3.fromRGB(255,255,255)
uC4vP.Parent=tB3nM
local vD5pS=Instance.new('TextButton')
vD5pS.Size=UDim2.new(1,-10,1,-10)
vD5pS.Position=UDim2.new(0,5,0,5)
vD5pS.BackgroundTransparency=0
vD5pS.BorderSizePixel=0
vD5pS.BackgroundColor3=Color3.fromRGB(0,0,0)
vD5pS.AutoButtonColor=false
vD5pS.Font=Enum.Font.Code
vD5pS.TextSize=20
vD5pS.Text=rQ1wE[sV2xK]
vD5pS.TextTransparency=.05
vD5pS.TextColor3=Color3.fromRGB(255,255,255)
vD5pS.Parent=tB3nM
Instance.new('UICorner',vD5pS).CornerRadius=UDim.new(0,12)
local wF6qT=Instance.new('UIStroke')
wF6qT.Thickness=1
wF6qT.Transparency=.35
wF6qT.Color=Color3.fromRGB(255,255,255)
wF6qT.Parent=vD5pS
vD5pS.MouseButton1Click:Connect(function()
	local a=rQ1wE[sV2xK]
	sV2xK=sV2xK%5+1
	local b=rQ1wE[sV2xK]
	vD5pS.Text=b
	if a=='Select'and b~='Select'then yM2nP={} for _,h in pairs(zR3tU)do h:Destroy()end zR3tU={} end
end)

local function rP2vN(p)while p do if p.ClassName=='Accessory'then return 1 end p=p.Parent end end
local function sV4kZ(c)for _,v in ipairs(c:GetChildren())do if v:IsA'Humanoid'then return v end end end
local function tX7rW(c)for _,v in ipairs(c:GetChildren())do if v:IsA'ForceField'then return 1 end end end
local function uX5bC(c)for _,v in ipairs(c:GetChildren())do if v.Name=='Head'and v:IsA'BasePart'then return v end end end
local function wJ7nL()
	local c=dV6nH.Character
	if not c then return end
	for _,v in ipairs(c:GetChildren())do
		local n=v.Name
		if (n=='RightHand'or n=='RightLowerArm'or n=='RightUpperArm'or n=='Right Arm')and v:IsA'BasePart'then gR1cU=v return end
	end
end

local function A9kLm(p)
	if not p then for _,h in pairs(zR3tU)do h:Destroy()end zR3tU={} return end
	local u=p.UserId
	local c=p.Character
	if not c then return end
	local h=zR3tU[u]
	if not h then h=Instance.new('Highlight')h.FillTransparency=1 h.OutlineColor=Color3.new(1,0,0)h.Parent=cL9pR zR3tU[u]=h end
	h.Adornee=c
end

local zQ3aS

local function xT7rW(p)
	fY8kP[p]=os.clock()
	p.AncestryChanged:Connect(function(_,pp)
		if not pp then
			fY8kP[p]=nil
			if eJ3sW[p]and zQ3aS then zQ3aS(p)end
			if kM8qT==p then kM8qT=nil lQ3wE=nil end
		end
	end)
	p.CharacterAdded:Connect(function()
		fY8kP[p]=os.clock()
		if kM8qT==p then kM8qT=nil lQ3wE=nil end
		if yM2nP[p.UserId]then A9kLm(p)end
	end)
end
for _,p in ipairs(aB3dE:GetPlayers())do if p~=dV6nH then xT7rW(p)end end
aB3dE.PlayerAdded:Connect(function(p)
	if p~=dV6nH then xT7rW(p)end
	if yM2nP and p.UserId==yM2nP then A9kLm(p)end
end)
aB3dE.PlayerRemoving:Connect(function(p)
	fY8kP[p]=nil
	if eJ3sW[p]then eJ3sW[p]=nil end
	if kM8qT==p then kM8qT=nil lQ3wE=nil end
	if yM2nP[p.UserId]then yM2nP[p.UserId]=nil local h=zR3tU[p.UserId] if h then h:Destroy()zR3tU[p.UserId]=nil end end
end)

local function yZ6aD(c,hd,t)
	t=t or{[0]={}}
	local s=t[0]
	for _,m in ipairs(c:GetDescendants())do
		local cn=m.ClassName
		if (cn=='Motor6D'or cn=='Weld'or cn=='WeldConstraint')and not s[m]then
			local p0,p1=m.Part0,m.Part1
			local o=nil
			if p0==hd then o=p1 elseif p1==hd then o=p0 end
			if o and not rP2vN(o)then
				if cn=='Motor6D'then t[#t+1]={m,p0,p1,m.C0,m.C1,m.Enabled,cn}m.Enabled=false m.Part0=nil m.Part1=nil
				elseif cn=='Weld'then t[#t+1]={m,p0,p1,m.C0,m.C1,cn}m.Part0=nil m.Part1=nil
				else t[#t+1]={m,p0,p1,cn}m.Part0=nil m.Part1=nil end
				s[m]=1
			end
		end
	end
	return t
end
zQ3aS=function(p)
	local t=eJ3sW[p]
	if not t then return end
	for i=1,#t do
		local e=t[i]
		local m=e[1]
		if m then
			local cn=e[#e]
			if cn=='Motor6D'then m.Part0=e[2]m.Part1=e[3]m.C0=e[4]m.C1=e[5]m.Enabled=e[6]
			elseif cn=='Weld'then m.Part0=e[2]m.Part1=e[3]m.C0=e[4]m.C1=e[5]
			elseif cn=='WeldConstraint'then m.Part0=e[2]m.Part1=e[3]end
		end
	end
	eJ3sW[p]=nil
end

dV6nH.CharacterAdded:Connect(function(c)
	gR1cU=nil
	wJ7nL()
	c.ChildAdded:Connect(function(v)
		local n=v.Name
		if (n=='RightHand'or n=='RightLowerArm'or n=='RightUpperArm'or n=='Right Arm')and v:IsA'BasePart'then gR1cU=v end
	end)
end)
if dV6nH.Character then wJ7nL()end

xY7zA=dE4fG.InputBegan:Connect(function(i,g)
	if g or i.KeyCode~=Enum.KeyCode.H or rQ1wE[sV2xK]~='Select'then return end
	local cam=workspace.CurrentCamera
	if not cam then return end
	local mp=dE4fG:GetMouseLocation()
	local bd,bp=1/0,nil
	for _,p in ipairs(aB3dE:GetPlayers())do
		if p~=dV6nH then
			local c=p.Character
			if c then
				local rp=nil
				for _,v in ipairs(c:GetChildren())do if v.Name=='HumanoidRootPart'and v:IsA'BasePart'then rp=v break end end
				if rp then
					local v2,on=cam:WorldToViewportPoint(rp.Position)
					if on then
						local dx,dy=v2.X-mp.X,v2.Y-mp.Y
						local d=dx*dx+dy*dy
						if d<bd then bd=d bp=p end
					end
				end
			end
		end
	end
	if bp then
	local u=bp.UserId
	if yM2nP[u]then
		yM2nP[u]=nil
		local h=zR3tU[u]
		if h then h:Destroy()zR3tU[u]=nil end
	else
		yM2nP[u]=1
		A9kLm(bp)
	end
end
end)

local function A1b2C()
	if not hN2mQ then return end
	if not gR1cU or not gR1cU.Parent then wJ7nL()end
	local md=rQ1wE[sV2xK]
	local np=nil
	if md=='Select'then
		local L={}
		for _,p in ipairs(aB3dE:GetPlayers())do
			if p~=dV6nH and yM2nP[p.UserId]then
				local t0=fY8kP[p]
				local c=p.Character
				if t0 and c and os.clock()-t0>0.1 and not tX7rW(c)then
					local h=sV4kZ(c)
					if h and h.Health>0 then
						local hd=uX5bC(c)
						if hd and hd.Parent then L[#L+1]=p end
					end
				end
			end
		end
		np=#L>0 and L[math.random(#L)]or nil
		if not np then if kM8qT then zQ3aS(kM8qT)kM8qT=nil lQ3wE=nil end return end
	else
		local L,mp,my={},nil,-1/0
		for p,t0 in pairs(fY8kP)do
			local c=p.Character
			if c and os.clock()-t0>0.1 and not tX7rW(c)then
				local h=sV4kZ(c)
				if h and h.Health>0 then
					local ok=1
					if md=='Team'or md=='Both'then local tm=p.Team if not(tm and tm.Name=='생존자')then ok=nil end end
					if ok then
						local hd=uX5bC(c)
						if hd and hd.Parent then
							if md=='Height'or md=='Both'then
								local rp=nil
								for _,v in ipairs(c:GetChildren())do if v.Name=='HumanoidRootPart'and v:IsA'BasePart'then rp=v break end end
								local y=rp and rp.Position.Y or -1/0
								if y>my then my=y mp=p end
							else
								L[#L+1]=p
							end
						end
					end
				end
			end
		end
		np=mp or(#L>0 and L[math.random(#L)]or nil)
	end
	if not np then if kM8qT then zQ3aS(kM8qT)kM8qT=nil lQ3wE=nil end return end
	if kM8qT~=np then if kM8qT then zQ3aS(kM8qT)end kM8qT=np lQ3wE=nil end
	local c=np.Character
	if not c then if kM8qT then zQ3aS(kM8qT)kM8qT=nil lQ3wE=nil end return end
	local hd=uX5bC(c)
	if not hd or not hd.Parent then if kM8qT then zQ3aS(kM8qT)kM8qT=nil lQ3wE=nil end return end
	eJ3sW[np]=yZ6aD(c,hd,eJ3sW[np])
	if not gR1cU or not gR1cU.Parent then return end
	local base=gR1cU.CFrame*CFrame.new(0,-1,1)
	local rx,ry,rz=math.rad(math.random(-180,180)),math.rad(math.random(-180,180)),math.rad(math.random(-180,180))
	hd.CFrame=base*CFrame.Angles(rx,ry,rz)
	hd.Velocity=Vector3.new(0,1)
	hd.RotVelocity=Vector3.new()
	lQ3wE=hd
	if md=='Select'and np then A9kLm(np)end
end

local function D3e4F()
	if not hN2mQ then return end
	local hd=lQ3wE
	if hd and hd.Parent then hd.CanCollide=false end
end

pD9hV.MouseButton1Click:Connect(function()
	hN2mQ=not hN2mQ
	pD9hV.Text=hN2mQ and'ON'or'OFF'
	if hN2mQ then
		if iP4sT then iP4sT:Disconnect()end
		if jK7uL then jK7uL:Disconnect()end
		iP4sT=bT2xK.Heartbeat:Connect(A1b2C)
		jK7uL=bT2xK.RenderStepped:Connect(D3e4F)
	else
		if iP4sT then iP4sT:Disconnect()iP4sT=nil end
		if jK7uL then jK7uL:Disconnect()jK7uL=nil end
		if kM8qT then zQ3aS(kM8qT) kM8qT=nil lQ3wE=nil end
		local rm={}
		for p,_ in pairs(eJ3sW)do rm[#rm+1]=p end
		for i=1,#rm do zQ3aS(rm[i])end
	end
end)
